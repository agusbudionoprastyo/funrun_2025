<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Data</title>

    <!-- Flowbite CSS (Tailwind CSS is automatically included in Flowbite) -->
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />

    <!-- IziToast CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/izitoast/dist/css/iziToast.min.css" />

    <!-- jQuery Library -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>

    <!-- Simple DataTables CDN -->
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@9.0.3"></script>
</head>

<body class="bg-gray-100">

<!-- Container for the Table -->
<div class="container mx-auto p-6">
    <table id="pagination-table" class="table-auto w-full text-sm text-left text-gray-500 border-collapse">
        <thead class="bg-blue-100">
            <tr>
                <th class="px-6 py-3 font-medium text-gray-900">
                    Nama
                </th>
                <th class="px-6 py-3 font-medium text-gray-900">
                    Mantan
                </th>
                <th class="px-6 py-3 font-medium text-gray-900">
                    Email
                </th>
                <th class="px-6 py-3 font-medium text-gray-900">
                    Phone
                </th>
                <th class="px-6 py-3 font-medium text-gray-900">
                    Amount
                </th>
                <th class="px-6 py-3 font-medium text-gray-900">
                    Transaction Date
                </th>
                <th class="px-6 py-3 font-medium text-gray-900">
                    Status
                </th>
                <th class="px-6 py-3 font-medium text-gray-900">
                </th>
            </tr>
        </thead>
        <tbody class="bg-white">
            <!-- Data rows will be inserted here dynamically -->
        </tbody>
    </table>
</div>


<!-- IziToast JS -->
<script src="https://cdn.jsdelivr.net/npm/izitoast/dist/js/iziToast.min.js"></script>
<!-- Flowbite -->
<script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

<!-- Modal HTML -->
<div id="update-status-modal" tabindex="-1" class="hidden overflow-y-auto overflow-x-hidden fixed inset-0 z-50 flex justify-center items-center w-full h-full">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white shadow-lg">

            <!-- Image (Payment Proof) -->
            <img id="payment-proof-image" class="w-full h-auto mb-4" src="" alt="Payment Proof" />

            <!-- Close Button -->
            <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-50 hover:bg-opacity-50 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center" id="close-modal">
                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                </svg>
                <span class="sr-only">Close modal</span>
            </button>

            <!-- Modal Content -->
            <div class="p-4 space-y-4">
                <!-- Transaction Details -->
                <h5 id="modal-name" class="text-lg font-semibold tracking-tight text-gray-900">Name Here</h5>
                <div class="flex items-center justify-between">
                    <span id="modal-amount" class="text-xl font-bold text-gray-900">Rp0</span>
                    <button type="button" id="verified-btn" class="bg-blue-500 text-white hover:bg-blue-600 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function fetchData() {
        try {
            const response = await fetch('get_transactions.php');
            const data = await response.json(); // Assuming the response is in JSON format

            const tableBody = document.querySelector("#pagination-table tbody");
            tableBody.innerHTML = ''; // Clear existing rows

            // Loop through the data and create table rows dynamically
            data.forEach(item => {
                const formattedAmount = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(item.total_amount);

                const row = document.createElement("tr");
                row.classList.add('border-b');

                let badge_class = item.badge_class;

                row.innerHTML = `
                    <td class="px-6 py-4">${item.name_1} ${item.name_2 ? ' / ' + item.name_2 : ''}</td>
                    <td class="px-6 py-4">${item.mantan_1} ${item.mantan_2 ? ' / ' + item.mantan_2 : ''}</td>
                    <td class="px-6 py-4">${item.email_1} ${item.email_2 ? ' / ' + item.email_2 : ''}</td>
                    <td class="px-6 py-4">${item.phone_1} ${item.phone_2 ? ' / ' + item.phone_2 : ''}</td>
                    <td class="px-6 py-4">${formattedAmount}</td>
                    <td class="px-6 py-4">${item.transaction_date}</td>
                    <td class="px-6 py-4">
                        <span class="${badge_class}">
                            ${item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        // <button class="update-status-btn text-white bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg" data-transaction-id="${item.transaction_id}" data-name="${item.name_1} ${item.name_2}" data-email="${item.email_1}" data-phone="${item.phone_1}" data-amount="${formattedAmount}" data-payment-img="../users/paymentprooft/${item.payment_prooft}" data-current-status="${item.status}">
                        //     Update Status
                        // </button>
                        <button type="button" class="update-status-btn text-gray-900 bg-white hover:bg-gray-100 border border-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:focus:ring-gray-800 dark:bg-white dark:border-gray-700 dark:text-gray-900 dark:hover:bg-gray-200 me-2 mb-2" data-transaction-id="${item.transaction_id}" data-name="${item.name_1} ${item.name_2}" data-email="${item.email_1}" data-phone="${item.phone_1}" data-amount="${formattedAmount}" data-payment-img="../users/paymentprooft/${item.payment_prooft}" data-current-status="${item.status}">
                        <svg aria-hidden="true" class="w-10 h-3 me-2 -ms-1" viewBox="0 0 660 203" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M233.003 199.762L266.362 4.002H319.72L286.336 199.762H233.003V199.762ZM479.113 8.222C468.544 4.256 451.978 0 431.292 0C378.566 0 341.429 26.551 341.111 64.604C340.814 92.733 367.626 108.426 387.865 117.789C408.636 127.387 415.617 133.505 415.517 142.072C415.384 155.195 398.931 161.187 383.593 161.187C362.238 161.187 350.892 158.22 333.368 150.914L326.49 147.803L319.003 191.625C331.466 197.092 354.511 201.824 378.441 202.07C434.531 202.07 470.943 175.822 471.357 135.185C471.556 112.915 457.341 95.97 426.556 81.997C407.906 72.941 396.484 66.898 396.605 57.728C396.605 49.591 406.273 40.89 427.165 40.89C444.611 40.619 457.253 44.424 467.101 48.39L471.882 50.649L479.113 8.222V8.222ZM616.423 3.99899H575.193C562.421 3.99899 552.861 7.485 547.253 20.233L468.008 199.633H524.039C524.039 199.633 533.198 175.512 535.27 170.215C541.393 170.215 595.825 170.299 603.606 170.299C605.202 177.153 610.098 199.633 610.098 199.633H659.61L616.423 3.993V3.99899ZM551.006 130.409C555.42 119.13 572.266 75.685 572.266 75.685C571.952 76.206 576.647 64.351 579.34 57.001L582.946 73.879C582.946 73.879 593.163 120.608 595.299 130.406H551.006V130.409V130.409ZM187.706 3.99899L135.467 137.499L129.902 110.37C120.176 79.096 89.8774 45.213 56.0044 28.25L103.771 199.45L160.226 199.387L244.23 3.99699L187.706 3.996" fill="#0E4595"/><path d="M86.723 3.99219H0.682003L0 8.06519C66.939 24.2692 111.23 63.4282 129.62 110.485L110.911 20.5252C107.682 8.12918 98.314 4.42918 86.725 3.99718" fill="#F2AE14"/></svg>
                            Confirm
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Initialize DataTable
            if (document.getElementById("pagination-table") && typeof simpleDatatables.DataTable !== 'undefined') {
                new simpleDatatables.DataTable("#pagination-table", {
                    searchable: true,
                    paging: true,
                    perPage: 5,
                    perPageSelect: [5, 10, 15, 20, 25],
                    sortable: false
                });
            }

        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    // Open the modal and populate with transaction details
    document.addEventListener('click', (event) => {
        if (event.target && event.target.classList.contains('update-status-btn')) {
            const transactionId = event.target.getAttribute('data-transaction-id');
            const name = event.target.getAttribute('data-name');
            const email = event.target.getAttribute('data-email');
            const phone = event.target.getAttribute('data-phone');
            const amount = event.target.getAttribute('data-amount');
            const paymentImg = event.target.getAttribute('data-payment-img');
            const currentStatus = event.target.getAttribute('data-current-status');

            // Populate modal with details
            document.getElementById('payment-proof-image').src = paymentImg; // Optionally set the image
            document.getElementById('modal-name').textContent = name;
            document.getElementById('modal-amount').textContent = amount;
            document.getElementById('verified-btn').dataset.transactionId = transactionId; // Add transactionId to the button for submission

            // Show the modal
            document.getElementById('update-status-modal').classList.remove('hidden');
        }
    });

    // Close the modal
    document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('update-status-modal').classList.add('hidden');
    });

    // Handle the status update form submission to Verified
    document.getElementById('verified-btn').addEventListener('click', async (event) => {
        const transactionId = event.target.dataset.transactionId;
        const newStatus = "Verified"; // Set status directly to "Verified"

        try {
            const response = await fetch('update_transactions.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ transaction_id: transactionId, status: newStatus }),
            });

            const result = await response.json();
            if (result.success) {
                alert('Status updated to Verified!');
                fetchData(); // Refresh the data after update
                document.getElementById('update-status-modal').classList.add('hidden'); // Close the modal
            } else {
                alert('Failed to update status. Please try again.');
            }
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Error updating status. Please try again.');
        }
    });

    // Call fetchData to populate the table
    fetchData();
</script>

</body>

</html>